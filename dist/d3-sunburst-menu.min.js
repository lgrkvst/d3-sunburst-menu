module.exports=function d3_sunburst_menu(tree,node,container){var radius=_radius=140;var rotate=_rotate=Math.PI/2;var hue=d3.scale.category10();var backSize=.1;var currentArc,currentNode=tree;var menuWaiter;var idleTime=300;var padAngle=.01;var dropshadow=false;var cornerRadius=4;var loaderDuration=4e3;var menu_level_scope=2;var maxRadius=190;var nudgeTolerance=4e3;var arcradius=function(inner_outer){return function(n){return Math.atan(n.depth+inner_outer+1.2*radius/_radius-1)*radius-inner_outer*3}};var arc=d3.svg.arc().startAngle(function(d){return rotate+d.x}).endAngle(function(d){return rotate+d.x+d.dx}).innerRadius(arcradius(0)).outerRadius(arcradius(1)).padAngle(padAngle).cornerRadius(cornerRadius);var backArc=d3.svg.arc().startAngle(arc.startAngle()).endAngle(arc.endAngle()).innerRadius(arcradius(-.2)).outerRadius(arcradius(1)).padAngle(4*padAngle).cornerRadius(cornerRadius);function fill(d){if(d.fill)return d3.hsl(d.fill);var p=d;var i=0;while(p.depth>1){if(i==0){i=p.parent.children.indexOf(p)/p.parent.children.length}p=p.parent}var c=p.fill?fill(p):d3.hsl(hue(label(p)));c.l=luminance(i);c.s=saturation(d.depth);d.fill=c;return c}var saturation=d3.scale.linear().domain([0,4]).clamp(false).range([.5,1]);var luminance=d3.scale.linear().domain([0,1]).clamp(false).range([.5,.15]);var partition=d3.layout.partition().sort(function(a,b){return d3.ascending(a.name,b.name)}).size([2*Math.PI,radius]).value(function(d){return d.depth});function promise_fail(d){return function(reject){d.name="ERROR";d3.selectAll("text.curved").select("textPath").text(label);d3.selectAll("#"+prefix_id("loader_")(d)).transition().duration(0)}}partition.children(function(d){if(children_pending(d)){d._children.then(function(a){d._children=a;d3.select("#"+prefix_id("loader_")(d)).remove();traverse(currentNode);d3.selectAll(".loader").transition().ease("exp-out").duration(function(d){return loaderDuration-this.getAttribute("T")*loaderDuration}).attrTween("d",function(d){var i=d3.interpolate({dx:this.getAttribute("T")},d);return function(t){return arc(i(t))}})},promise_fail(d))}return d.depth<menu_level_scope?d._children:null});partition.value(function(d){return 1/(d.parent.children.length*d.depth)}).nodes(tree);var radialmenu=container.append("g").attr("id","radialmenu").attr("transform","translate("+node.x+","+node.y+")");var filter=container.append("defs").append("filter").attr("id","dropshadow").attr("x","0").attr("y","0").attr("width","200%").attr("height","200%");filter.append("feOffset").attr("result","offOut").attr("in","SourceAlpha").attr("dx","0").attr("dy","0");filter.append("feGaussianBlur").attr("result","blurOut").attr("in","offOut").attr("stdDeviation","8");filter.append("feBlend").attr("in","SourceGraphic").attr("in2","blurOut").attr("mode","normal");if(dropshadow){radialmenu.attr("filter","url(#dropshadow)")}container.on("mousemove",function(){var currentArc,offset=-10;var r=arc.outerRadius()(tree)-offset;var m=d3.mouse(this);var s=radialmenu.attr("transform").match(/translate\(([\d\.]+)[\s,]([\d\.]+)/).filter(function(a,b){return b?a:false});if((m[0]-s[0])*(m[0]-s[0])+(m[1]-s[1])*(m[1]-s[1])>r*r+nudgeTolerance){var A=Math.atan2(m[1]-s[1],m[0]-s[0]);radialmenu.attr("transform","translate("+Math.round(1*m[0]-Math.cos(A)*r)+","+Math.round(1*m[1]-Math.sin(A)*r)+")");clearTimeout(menuWaiter);if(currentArc=d3.select(".mouseover")[0][0]){var m_local=d3.mouse(radialmenu[0][0]);menuWaiter=setTimeout(zoom,idleTime,currentArc.__data__,localToPolar(m_local))}}});traverse(tree);function localToPolar(m){var rad=Math.sqrt(m[0]*m[0]+m[1]*m[1]);var deg=Math.atan2(m[1],m[0]);deg+=1/2*Math.PI;if(deg<0)deg+=2*Math.PI;return[rad,deg]}function zoom(p,clickLocation){var currentArc=d3.select(".mouseover")[0][0];if(currentArc==null)return;if(currentArc&&currentArc.__data__!=p)return;if(label(p)=="BACK"){traverse(currentNode.parent,clickLocation);return}if(p.callback){p.callback(node);return}if(p.depth){traverse(p,clickLocation)}else{traverse(p.parent,clickLocation)}}function traverse(tree,clickLocation){radius=Math.pow(tree._children.length,1/3)*_radius/1.6;if(radius>190){radius=maxRadius}if(radius<_radius){radius=_radius}currentNode=tree;var cursorData=[];if(tree.parent){partition.size([2*Math.PI*(1-backSize),radius]);rotate=clickLocation[1]+Math.PI*backSize;cursorData=[{x:clickLocation[1]-Math.PI*backSize-rotate,dx:2*(Math.PI*backSize),id:"cursor",name:"BACK",fill:"#333"}]}else{partition.size([2*Math.PI,radius]);rotate=_rotate}group=d3.select("#radialmenu").selectAll("g.menuitem").data(partition(tree),function(n){return n.id});cursor=d3.select("#radialmenu").selectAll("g.cursor").data(cursorData,function(n){return n.id});cursor.exit().remove();cursor.enter().append("g").attr("class","cursor").append("path").attr("id",prefix_id("path_")).each(addText).each(addGradient).each(addClipPath);group.exit().remove();group.enter().append("g").attr("class",item=>"menuitem "+"menuitem_"+item.id).append("path").attr("class","menuitem").attr("id",prefix_id("path_")).each(addGradient).each(addText).each(addClipPath).filter(children_pending).each(addLoaders);group.selectAll("path").filter(function(n){return!children_pending(n)}).style("visibility",function(b){return b.depth?"visible":"hidden"});group.transition().duration(500).ease("elastic").each(function(){d3.selectAll("g.radial").transition().ease("cubic-out").duration(500).attr("transform",function(n){return"translate("+.8*arc.innerRadius()(n)*Math.sin(n.x+n.dx/2+rotate)+","+.8*(-arc.innerRadius()(n)*Math.cos(n.x+n.dx/2+rotate))+")"});d3.selectAll("text.radial").transition().ease("cubic-out").duration(500).attr("transform",function(n){return"rotate("+(n.x+n.dx/2+rotate-Math.PI/2)*180/Math.PI+")"});d3.selectAll("text.curved").filter(function(d){return d.depth}).attr("font-size",function(d){return arc.outerRadius()(d)-arc.innerRadius()(d)}).attr("dy",function(d){return(arc.outerRadius()(d)-arc.innerRadius()(d))*.85}).transition().duration(250).ease("ease-in").styleTween("fill-opacity",function(n){var f=d3.interpolate(0,1);return function(i){return f(i)}});d3.selectAll("path.labelpath").filter(function(d){return d.depth}).attr("d",function(n){return"M "+arc.outerRadius()(n)*Math.sin(n.x+n.dx/2+rotate-Math.PI/2)+" "+-arc.outerRadius()(n)*Math.cos(n.x+n.dx/2+rotate-Math.PI/2)+"                             A "+arc.outerRadius()(n)+" "+arc.outerRadius()(n)+",                             0, 0, 1,                             "+arc.outerRadius()(n)*Math.sin(n.x+n.dx/2+rotate+Math.PI/2)+" "+-arc.outerRadius()(n)*Math.cos(n.x+n.dx/2+rotate+Math.PI/2)})}).selectAll("path.menuitem").attrTween("d",tweenDonut);cursor.select("path").transition().duration(500).ease("cubic-out").attrTween("d",function(n){var s=d3.interpolate({depth:.9},n);return function(i){return backArc(s(i))}});d3.select("#radialmenu").selectAll("g").on("mouseover",function(n){this.setAttribute("class","menuitem mouseover")}).on("mouseout",function(n){this.setAttribute("class","menuitem")});function tweenDonut(b){var impact=0;if(b.impact){impact=b.impact;delete b.impact}var inout=b.depth==1?1:-.4;var i=d3.interpolate({depth:b.depth+inout+impact,x:b.x-.3*inout},b);return function(t){return arc(i(t))}}function addLoaders(g){d3.select(this.parentNode).insert("path",":nth-child(2)").attr("class","loader").attr("T",0).style("fill",prefix_id("url('#gradient_")).attr("id",prefix_id("loader_")).transition().attr("T",1).ease("exp-out").duration(loaderDuration).attrTween("d",function(d){var i=d3.interpolate({dx:0},g);return function(t){return arc(i(t))}})}}function label(n){var label=n.name||n.id||"";return label.toUpperCase()}function prefix_id(prefix){return function(n){var label=n.id||n.name||"";label=label.toUpperCase();label=label.replace(/[ )(]/g,"");return prefix+label}}function children_pending(d){return d._children&&d._children.then}function addText(g){if(!g.depth)return;function should_radiate(g){while(g.parent){if(g["text-align"]=="radiate"){return true}g=g.parent}return false}try{if(g._children||!should_radiate(g)){addCurvedText.call(this)}else{addRadialText.call(this)}}catch(err){}}function addClipPath(g){d3.select(this.parentNode).append("clipPath").attr("id",prefix_id("clipPath_")).append("use").attr("xlink:href",prefix_id("#path_"))}function addCurvedText(){d3.select(this.parentNode).append("path").attr("class","labelpath").style("fill","none").attr("id",prefix_id("textpath_"));d3.select(this.parentNode).append("text").attr("clip-path",prefix_id("url(#clipPath_")).attr("class","nodelabeltext").attr("class","curved").attr("pointer-events","none").append("textPath").attr("xlink:href",prefix_id("#textpath_")).text(label).attr("startOffset",function(n){return"50%"}).attr("text-anchor","middle").attr("letter-spacing",function(n){return 3-n.depth})}function addRadialText(g){d3.select(this.parentNode).append("g").attr("class","radial").append("text").text(label).attr("class","radial").attr("dx",50)}function addGradient(){var gradients=d3.select(this.parentNode).append("radialGradient").attr("id",prefix_id("gradient_")).attr("cx","0%").attr("cy","0%").attr("fx","0%").attr("fy","0%").attr("r","100%");gradients.append("stop").attr("stop-color",function(n){return fill(n).brighter()}).attr("offset","0%").attr("stop-opacity","100%");gradients.append("stop").attr("stop-color",function(n){return fill(n)}).attr("offset","100%").attr("stop-opacity","100%");d3.select(this).style("fill",prefix_id("url('#gradient_"))}return{redraw:function(){traverse(currentNode)},remove:function(){radialmenu.remove()},tree:function(){return tree}}};
